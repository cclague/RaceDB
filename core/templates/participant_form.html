{% extends "base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load static %}
{% load staticfiles %}

{% block srcjavascript %}
	{% if participant.competition.show_signature and participant.signature and not participant.is_jsignature %}
		<script type="text/javascript" src="{% static "js/scriptel-easyscript.js" %}"></script>
	{% endif %}
{% endblock srcjavascript %}

{% block onload %}
	{% if participant.competition.show_signature and participant.signature and not participant.is_jsignature %}
		var escript = new ScriptelEasyScript();
		var canvas = document.getElementById("signature");
		var ctx = canvas.getContext("2d");
		ctx.fillStyle="#FFFF88";
		ctx.fillRect(0,0,canvas.width,canvas.height);
		var sig = {{participant.signature|safe}};
		escript.drawSignatureOnCanvas(sig, canvas);
	{% endif %}
	
	{% include "antenna_watermark.html" %}
{% endblock onload %}

{% block content %}
<style>
.Row:hover {
	background-color: #EEE;
}
.table tbody>tr>td {
	vertical-align: middle;
	font-size: 135%;
	border-top: none;
	padding: 3px;
}
</style>
{% if title %}<h1>{{title}}</h1><br/>{% endif %}

<h3 class="visible-print text-center">{% trans "Race Voucher" %}</h3>
<hr class="visible-print" />
{% with p=participant h=participant.license_holder c=participant.competition %}
<h2><strong>{{c.name}}</strong>: {{c.start_date}}
</h2>
<hr/>
{% spaceless %}
<table class="table table-hover table-condensed">
<tr onclick="jump({% if isEdit %}'{{path}}LicenseHolderEdit/{{h.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Participant" %}{% if not p.good_license or not p.good_uci_code %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
	<td>
		<strong>{{h.full_name}}:</strong>
		{{h.get_gender_display}}
		{% if h.license_code %}
			{% if isEdit and h.is_temp_license %}<a class="btn btn-warning" href='{{path}}LicenseHolderEdit/{{h.id}}/'>{% endif %}
				{{h.license_code_trunc}}
			{% if isEdit and h.is_temp_license %}</a>{% endif %}
		{% endif %}
		{% if h.uci_code %}
			{% if h.uci_country %} <img class="flag" src="{% get_static_prefix %}flags/{{h.uci_country}}.png" ></img>{% endif %}
			{% if isEdit and h.uci_code_error %}<a class="btn btn-warning" href='{{path}}LicenseHolderEdit/{{h.id}}/'>{% endif %}
				{{h.uci_code}}
			{% if isEdit and h.uci_code_error %}</a>{% endif %}
		{% endif %}
		{% if h.city %} {{h.city}}, {% endif %}
		{% if h.state_prov %} {{h.state_prov}}, {% endif %}
		{% if h.nationality %} {{h.nationality}} {% endif %}
		{% if isEdit and h.license_code and h.is_temp_license %}
			<br/><a class="btn btn-warning" href='{{path}}LicenseHolderEdit/{{h.id}}/'>{% trans "Click here to fix License Code" %}</a>
		{% endif %}
		{% if isEdit and h.uci_code and h.uci_code_error %}
			<br/><a class="btn btn-warning" href='{{path}}LicenseHolderEdit/{{h.id}}/'>{% trans "Click here to fix UCI Code" %}: {{h.uci_code_error}}</a>
		{% endif %}
	</td>
	<td>
		{% if isEdit %}
			<a class="btn btn-success hidden-print" href="{{path}}LicenseHolderEdit/{{h.id}}/">{% trans "Edit" %}</a>
		{% endif %}
	</td>
</tr>

{% if c.has_waiver %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantWaiverChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Waiver" %}{% if p.has_unsigned_waiver %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
	<td>
		<strong>{% if p.has_unsigned_waiver %}{% trans "Required" %}{% else %}{% trans "Correct" %}{% endif %}</strong>
	</td>
	<td>
		{% if isEdit %}
			<a class="btn btn-success hidden-print" href="{{path}}ParticipantWaiverChange/{{p.id}}/">{% trans "Change" %}</a>
		{% endif %}
	</td>
</tr>
{% endif %}

<tr onclick="jump({% if request.user.is_superuser and isEdit %}'{{path}}ParticipantRoleChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Role" %}:</td>
	<td>
		<strong>{{p.get_role_display}}</strong>
		{% if p.is_competitor %}
			&nbsp;&nbsp;&nbsp;&nbsp;
			{% if is_suspicious_age and isEdit %}<a class="btn btn-warning" href='{{path}}LicenseHolderEdit/{{h.id}}/'>{% endif %}
				{% trans "Competition Age" %}: <strong>{{competition_age}}
			{% if is_suspicious_age and isEdit %}</a>{% endif %}</strong>
			{% if is_suspicious_age and isEdit %}
				<br/><a class="btn btn-warning" href='{{path}}LicenseHolderEdit/{{h.id}}/'>{% trans "Click here to fix Date of Birth" %}</span>
			{% endif %}
		{% endif %}
	</td>
	<td>
		{% if request.user.is_superuser and isEdit %}
			<a class="btn btn-success hidden-print" href="{{path}}ParticipantRoleChange/{{p.id}}/">{% trans "Change" %}</a>
		{% endif %}
	</td>
</tr>

{% if p.is_with_team %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantTeamChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Team" %}:</td>
	<td>
		{% if p.team %}
			<strong>{{p.team.name}}</strong><span>
			{% if p.team.code %}, {{p.team.code}}{% endif %}</span>,
			{{p.team.get_team_type_display}}<span>
			{% if p.team.nation_code %}, {{p.team.nation_code}}{% endif %}</span>
		{% else %}
			<span class="label label-danger">{% trans "No team" %}</span>
		{% endif %}
	</td>
	<td>
		{% if isEdit %}
			<a class="btn btn-success hidden-print" href="{{path}}ParticipantTeamChange/{{p.id}}/">{% trans "Change" %}</a>
		{% endif %}
	</td>
</tr>
{% endif %}
{% if p.is_competitor %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantCategoryChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Category" %}{% if not p.good_category %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
	<td>
		{% if p.category %}
			<strong>{{p.category.code}}:</strong>
			{{p.category.description}}, {{p.category.get_gender_display}}
		{% else %}
			{% if p.is_competitor %}<span class="label label-danger">{% endif %}
				{% trans "No category" %}
			{% if p.is_competitor %}</span>{% endif %}
		{% endif %} 
	</td>
	<td>
		{% if isEdit %}
			<a class="btn btn-success hidden-print" href="{{path}}ParticipantCategoryChange/{{p.id}}/">{% trans "Change" %}</a>
		{% endif %}
	</td>
</tr>
{% if p.is_competitor and p.category %}
<tr {% if request.user.is_superuser and isEdit %}onclick="jump('{{path}}ParticipantPreregisteredChange/{{p.id}}/');"{% endif %}>
	<td class="text-right">{% trans "Preregistered" %}:</td>
	<td>
		{% if p.preregistered %}
			<span class="label label-default"><image src="{% static "images/glyphicons_206_ok_2.png" %}" > {% trans "Yes" %}</span>
		{% else %}
			<span class="label label-danger"><image src="{% static "images/glyphicons_207_remove_2.png" %}" > {% trans "No" %}</span>
		{% endif %}
	</td>
	{% if request.user.is_superuser and isEdit %}
		<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantPreregisteredChange/{{p.id}}/">{% trans "Change" %}</a></td>
	{% endif %}
</tr>
{% endif %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantPaidChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Paid" %}{% if not p.good_paid %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
	<td>
		{% if p.paid %}
			<span class="label label-default"><image src="{% static "images/glyphicons_206_ok_2.png" %}" > {% trans "Yes" %}</span>
		{% else %}
			<span class="label label-danger"><image src="{% static "images/glyphicons_207_remove_2.png" %}" > {% trans "No" %}</span>
		{% endif %}
		{% if p.is_seasons_pass_holder %} {% trans "(Season's Pass Holder)" %} {% endif %}
	</td>
	{% if isEdit %}
		<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantPaidChange/{{p.id}}/">{% trans "Change" %}</a></td>
	{% endif %}
</tr>
{% endif %}
{% if p.category and p.is_competitor %}
	<tr onclick="jump({% if isEdit %}'{{path}}ParticipantBibChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
		<td class="text-right">{% trans "Bib" %}{% if not p.good_bib %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
		<td>
			{% if p.bib %} <strong>{{p.bib}}</strong> {% else %} <span class="label label-danger">{% trans "No bib" %}</span> {% endif %}
		</td>
		{% if isEdit %}
			<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantBibChange/{{p.id}}/">{% trans "Change" %}</a></td>
		{% endif %}
	</tr>
{% endif %}
{% if c.using_tags and p.is_competitor %}
	<tr onclick="jump({% if isEdit %}'{{path}}ParticipantTagChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
		<td class="text-right">{% if p.tag and p.tag2 %}{% trans "Chip Tags" %}{% else %}{% trans "Chip Tag" %}{% endif %}{% if not p.good_tag %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
		<td>
			{% if not p.tag and not p.tag2 %}
				 <span class="label label-danger">{% trans "No tag" %}</span>
			{% endif %}
			{% if p.tag %} <strong>{{p.tag}}{% if p.tag2 %},{% endif %}</strong>{% endif %}
			{% if p.tag2 %} <strong>{{p.tag2}} </strong>{% endif %}
		</td>
		{% if isEdit %}
			<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantTagChange/{{p.id}}/">{% trans "Change" %}</a></td>
		{% endif %}
	</tr>
{% endif %}
{% if p.has_tt_events and p.is_competitor %}
	<tr onclick="jump({% if isEdit %}'{{path}}ParticipantEstSpeedChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
		<td class="text-right">{% trans "Est. TT Speed" %}{% if not p.good_est_kmh %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
		<td>
		{% if p.est_kmh > 0.0 %}
			<strong>{{p.est_speed_display}}</strong>
		{% else %}
			<span class="label label-danger"><image src="{% static "images/glyphicons_207_remove_2.png" %}" > {% trans "No" %}</span>
		{% endif %}</td>
		{% if isEdit %}
			<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantEstSpeedChange/{{p.id}}/">{% trans "Change" %}</a></td>
		{% endif %}
	</tr>
{% endif %}
{% if p.show_confirm and p.is_competitor %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantConfirmedChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Confirmed" %}:</td>
	<td>
		{% if p.confirmed %}
			<span class="label label-default"><image src="{% static "images/glyphicons_206_ok_2.png" %}" > {% trans "Yes" %}</span>
		{% else %}
			<span class="label label-danger"><image src="{% static "images/glyphicons_207_remove_2.png" %}" > {% trans "No" %}</span>
		{% endif %}
	</td>
	{% if isEdit %}
		<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantConfirmedChange/{{p.id}}/">{% trans "Change" %}</a></td>
	{% endif %}
</tr>
{% endif %}
{% if c.show_signature and p.is_competitor and p.category %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantSignatureChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Signature" %}{% if not p.good_signature %}&nbsp;<img src="{% static "images/warning.png" %}" style="width:20px;height:20px;"\>{% endif %}:</td>
	<td>
	{% if p.signature %}
		{% if p.is_jsignature %}
			<image width="240" height="64" id="signature" src="data:{{p.signature|safe}}" style="background: #FFFF88"></image>
		{% else %}
			<canvas width="240" height="64" id="signature"></canvas>
		{% endif %}
	{% else %}
		<span class="label label-danger"><image src="{% static "images/glyphicons_207_remove_2.png" %}" > {% trans "No signature" %}</span>
	{% endif %}
	</td>
	{% if isEdit %}
		<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantSignatureChange/{{p.id}}/">{% trans "Change" %}</a></td>
	{% endif %}
</tr>
{% endif %}
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantNoteChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "Competition Note" %}:</td>
	<td>{% if p.note %}{{p.note}}{% endif %}</td>
	{% if isEdit %}
		<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantNoteChange/{{p.id}}/">{% trans "Change" %}</a></td>
	{% endif %}
</tr>
<tr onclick="jump({% if isEdit %}'{{path}}ParticipantGeneralNoteChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
	<td class="text-right">{% trans "General Note" %}:</td>
	<td>{% if h.note %}{{h.note}}{% endif %}</td>
	{% if isEdit %}
		<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantGeneralNoteChange/{{p.id}}/">{% trans "Change" %}</a></td>
	{% endif %}
</tr>
{% if p.has_optional_events and p.is_competitor %}
	<tr onclick="jump({% if isEdit %}'{{path}}ParticipantOptionChange/{{p.id}}/'{% else %}'{{path}}'{% endif %});">
		<td class="text-right">{% trans "Optional Events" %}:</td>
		<td>
			{% for event, optional, is_participating in p.get_participant_events %}
				{% if optional %}
					{% if is_participating %}<span class="label label-success">&#x2713;
					{% else %}<span class="label label-default">{% endif %}{{event.short_name}}
					{% if is_participating %}</span>{% endif %}
				{% endif %}
			{% endfor %}
		</td>
		{% if isEdit %}
			<td><a class="btn btn-success hidden-print" href="{{path}}ParticipantOptionChange/{{p.id}}/">{% trans "Change" %}</a></td>
		{% endif %}
	</tr>
{% endif %}
</table>
{% endspaceless %}

{% if p.is_competitor %}
	{% with sw=p.get_start_waves %}
		{% if sw %}
			<hr/>
				{% for w in sw %}
					<h3>
					{% trans "Mass Start" %} {{forloop.counter}}:
					<span class="label label-default">{{w.event.date_time|time}}</span>
					<strong>{{w.name}}</strong> -
					{{w.event.name}} -
					{{w.event_type_display_name}}
					{{w.event.date_time|date}}
					{% if w.is_late %}
						<span class="label label-warning">{% trans "Late Reg.  Alert Timing Immediately." %}</span>
					{% endif %}
					</h3>
				{% endfor %}
		{% endif %}
	{% endwith %}
	{% with swtt=p.get_start_wave_tts %}
		{% if swtt %}
			<hr/>
				{% for w in swtt %}
					<h3>
					{% trans "TT Start" %} {{forloop.counter}}:
					<span class="label label-default">{{w.event.date_time|time}}</span>
					<strong>{{w.name}}</strong> -
					{{w.event.name}} -
					{{w.event_type_display_name}}
					{{w.event.date_time|date}}
					{% if w.is_late %}
						<span class="label label-warning">{% trans "Late Reg.  Alert Timing Immediately." %}</span>
					{% endif %}
					</h3>
				{% endfor %}
		{% endif %}
	{% endwith %}
{% endif %}
	{% if isEdit and p.is_competitor %}
	{% with cat_part=p.get_category_participants %}
		<hr/>
		<h3>{% if cat_part|length <= 1 %}{% trans "Category" %}{% else %}{% trans "Categories" %}{% endif %}:
		{% if cat_part %}
			{% for cp in cat_part %}
				{% if isEdit %}
					<a class="btn btn-primary" href="{{popUrl}}ParticipantEdit/{{cp.id}}">
				{% else %}
					<span class="label label-primary">
				{% endif %}
						{% if cp.category %}{{cp.category.code_gender}}{% else %}{% trans "No Category" %}{% endif %}
						-
						{% if cp.bib %} {% trans "Bib" %}: {{cp.bib}} {% else %}{% trans "No Bib" %}{% endif %}
					</a>
				{% if isEdit %}
					</a>
				{% else %}
					</span>
				{% endif %}
			{% endfor %}
		{% else %}
			{% trans "None" %}
		{% endif %}
		{% if isEdit and add_multiple_categories %}
			<a class="btn btn-warning hidden-print" id="focus" href="./ParticipantAddToCompetitionDifferentCategoryConfirm/{{p.competition.id}}/{{p.license_holder.id}}">
				{% trans "Add Category" %}
			</a>
		{% endif %}
		</h3>
	{% endwith %}
	{% endif %}
<hr/>
	{% if isEdit %}
		{% if participant.is_done %}
			<a class="btn btn-success hidden-print" id="focus" href="{{cancelUrl}}">{% trans "Complete and Accurate. Process Next Entry" %}</a>
		{% else %}
			<a class="btn btn-warning hidden-print" id="focus" href="{{cancelUrl}}">{% trans "Incomplete. Process Next Entry Anyway" %}</a>
		{% endif %}
		<button class="btn btn-primary hidden-print" onclick="window.print();">{% trans "Print Race Voucher" %}</button>
	{% else %}
		<a class="btn btn-primary hidden-print" id="focus" href="{{cancelUrl}}">{% trans "Cancel" %}</a>
		<a class="btn btn-warning hidden-print" href="{{cancelUrl}}ParticipantDoDelete/{{p.id}}/">{% trans "OK" %}</a>
	{% endif %}

{% endwith %}
{% endblock content %}
